<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../data/d-music-data.html">
<link rel="import" href="../data/d-user-data.html">

<dom-module id="disc-home">
<template>
  <style>
    :host {
      display: block;
    }
  </style>
  <div>

    <d-user-data
      id="userdata"></d-user-data>

    <d-music-data 
      id="musicdata"
      music-data="{{music}}"
      music-nums="{{musicNums}}"
      playlist="{{playlist}}"></d-music-data>


    <button on-click="signIn">Sign In</button>
  
    <div>มีจำนวน [[ musicNums ]] เพลง</div>
    <input type="file" on-change="uploadMusic">
    <template is="dom-repeat" items="{{music}}" index-as="music_index">
      <div>
        [[ item.name ]]
        <div>[[ convertToMusic(item.music_blob, item.link) ]]</div>
        <button on-click="loadNewSong" data-music$="{{ item }}">Load New Song</button>
        <div>
          Add To Playlist
          <template is="dom-repeat" items={{playlist}} as="play">
            <div>[[ play.name ]] 
              <template is="dom-if" if="{{checkMusicInPlaylist(item.key, play)}}">
                <button on-click="removeFromPlaylist" data-playlist$="{{ play.name }}" data-music-key$="{{ item.key }}">Added</button>
              </template>
              <template is="dom-if" if="{{!checkMusicInPlaylist(item.key, play)}}">
                <button on-click="addToPlaylist" data-playlist$="{{ play.name }}" data-music-key$="{{ item.key }}">
                  Add
                </button>
              </template>
            </div>
          </template>
        </div>
      </div>
    </template>

    <h3>Playlist</h3>
    <input id="new_playlist" type="text">
    <button on-click="createNewplaylist">add playlist</button>
    <template is="dom-repeat" items={{playlist}} index-as=index>
      <div>[[ item.name ]]</div>
      <div>
        <template is="dom-repeat" items={{item.musics}} as="music_index">
          [[ music_index ]]
        </template>
      </div>
    </template>
    
  </div>
</template>
<script>
  class DiscHome extends Polymer.Element {
    static get is () { return 'disc-home' }
    static get properties () {
      return {}
    }

    signIn (evt) {
      this.$.userdata.signIn()
    }

    loadNewSong (evt) {
      this.$.musicdata.loadNewSong(JSON.parse(evt.target.getAttribute('data-music')))
    }

    createNewplaylist (evt) {
      this.$.musicdata.createNewplaylist(this.$.new_playlist.value)
    }

    uploadMusic (evt) {
      this.$.musicdata.uploadMusic(evt)
    }

    convertToMusic (blob, link) {
      return blob ? URL.createObjectURL(blob) : link
    }

    checkMusicInPlaylist (musicKey, playlist) {
      let { musics } = playlist
      return musics ? musics.indexOf(musicKey) > -1 : false
    }

    addToPlaylist (evt) {
      let { target } = evt
      this.$.musicdata.addToPlaylist(target.getAttribute('data-music-key'), target.getAttribute('data-playlist'))
    }

    removeFromPlaylist (evt) {
      let { target } = evt
      this.$.musicdata.removeFromPlaylist(target.getAttribute('data-music-key'), target.getAttribute('data-playlist'))
    }
  }
  window.customElements.define(DiscHome.is, DiscHome)
</script>
</dom-module>